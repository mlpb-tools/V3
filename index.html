<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchro-Board - Outil d'Analyse Stratégique</title>
    <style>
        :root {
            --bg-color: #f4f7fa;
            --main-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --header-color: #3498db;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --text-dark: #34495e;
            --text-light: #7f8c8d;
            --status-todo: #3498db;
            --status-inprogress: #f1c40f;
            --status-done: #2ecc71;
            --status-blocked: #e74c3c;
            --status-eval: #f1c40f;
            --status-accepted: #2ecc71;
            --status-refused: #e74c3c;
        }

        /* --- Structure Générale --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; display: flex; height: 100vh; overflow: hidden; background-color: var(--bg-color); color: var(--text-dark);
        }
        #sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }

        /* --- Barre Latérale (Collaborateurs) --- */
        #sidebar h1 { font-size: 1.6em; margin: 0 0 20px 0; text-align: center; font-weight: 600; }
        #collaborator-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        #collaborator-list li { padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; border-left: 4px solid transparent; }
        #collaborator-list li:hover { background-color: #34495e; }
        #collaborator-list li.active { background-color: var(--header-color); font-weight: 600; }
        #add-collaborator-btn { background-color: var(--header-color); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1em; }

        /* --- Contenu Principal --- */
        #header { padding: 15px 30px; background-color: var(--main-bg); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow); z-index: 10; }
        #header h2 { margin: 0; font-size: 1.8em; }
        #view-switcher { padding: 20px 30px 0 30px; background-color: var(--bg-color); }
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-light); }
        .tab.active { color: var(--header-color); border-bottom: 3px solid var(--header-color); }
        
        .view { display: none; padding: 20px 30px; }
        .view.active { display: block; }
        
        /* --- Styles Communs aux Vues --- */
        .view-container { display: flex; gap: 20px; height: calc(100vh - 150px); }
        .sidebar-container { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-container h3 { margin-top: 0; }
        .sidebar-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .sidebar-list li { padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; border: 1px solid var(--border-color); background: var(--main-bg); }
        .sidebar-list li.active { background-color: #eaf5ff; border-color: var(--header-color); }
        .add-item-btn { width: 100%; margin-top: 10px; padding: 10px; background-color: var(--status-done); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .detail-container { flex-grow: 1; background-color: var(--main-bg); padding: 20px; border-radius: 8px; box-shadow: var(--shadow); overflow-y: auto; }
        .detail-field { margin-bottom: 15px; }
        .detail-field label { display: block; font-weight: 600; margin-bottom: 5px; }
        .detail-field input, .detail-field textarea { width: 98%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-family: inherit; font-size: 1em; }
        .detail-field textarea { min-height: 80px; resize: vertical; }
        .analysis-btn { margin-left: 10px; background: none; border: none; cursor: pointer; font-size: 1.2em; }
        
        /* --- Styles spécifiques (Feuille de Route, CR, Propositions) --- */
        .roadmap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .roadmap-grid .detail-field.full { grid-column: span 2; }
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task { background-color: #fdfdfd; border: 1px solid var(--border-color); padding: 10px; margin-bottom: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .task.status-todo { border-left: 4px solid var(--status-todo); }
        .task.status-inprogress { border-left: 4px solid var(--status-inprogress); }
        .task.status-done { border-left: 4px solid var(--status-done); }
        .task.status-blocked { border-left: 4px solid var(--status-blocked); }
        .task-controls { display: flex; align-items: center; gap: 10px; }
        .task-status { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); }
        .delete-task-btn { background: none; border: none; cursor: pointer; color: #999; font-size: 1.5em; line-height: 1; }
        #add-task-form { display: flex; gap: 10px; margin-top: 15px; }
        #new-task-input { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; }
        #add-task-btn { padding: 8px 15px; border: none; background-color: var(--status-todo); color: white; border-radius: 5px; cursor: pointer; }
        #decision-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #decision-table th, #decision-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        #decision-table th { background-color: #f8f9fa; }
        #decision-table input { width: 95%; border: none; }
        .delete-row-btn { cursor: pointer; color: var(--status-refused); }
        .proposal-item-header { display: flex; justify-content: space-between; font-weight: 600; color: var(--text-dark); }
        .proposal-item-details { font-size: 0.85em; color: var(--text-light); margin-top: 4px; }
        .proposal-score { font-size: 1.1em; font-weight: bold; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8em; color: white; }
        .status-badge.eval { background-color: var(--status-eval); }
        .status-badge.accepted { background-color: var(--status-accepted); }
        .status-badge.refused { background-color: var(--status-refused); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .info-item { background-color: #f8f9fa; padding: 15px; border-radius: 6px; }
        .info-item h4 { margin: 0 0 5px 0; color: var(--text-light); font-size: 0.9em; }
        .info-item p { margin: 0; font-size: 1.1em; }
        .criterion { background-color: var(--main-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .criterion-header { display: flex; justify-content: space-between; align-items: center; }
        .criterion-header label { font-weight: 600; flex-grow: 1; font-size: 0.9em; }
        .criterion-score { display: flex; align-items: center; gap: 10px; }
        .criterion-score input[type="range"] { width: 120px; }
        .criterion-score span { font-weight: bold; width: 40px; text-align: center; }
        .criterion-comment-area { margin-top: 10px; }
        .swot-display { font-size: 0.9em; color: var(--text-light); border: 1px dashed var(--border-color); padding: 10px; border-radius: 5px; margin-top: 5px; }
        .swot-display p { margin: 0 0 5px 0; }
        .swot-display strong { color: var(--text-dark); }
        .summary-section { margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; }
        .summary-grid { display: flex; justify-content: space-between; align-items: center; }
        .total-score h3 { margin: 0; font-size: 1.2em; }
        .total-score p { margin: 5px 0 0; font-size: 2.5em; font-weight: bold; color: var(--header-color); }
        .decision-actions button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 600; margin-left: 10px; }
        .btn-eval { background-color: var(--status-eval); }
        .btn-accept { background-color: var(--status-accepted); color: white; }
        .btn-refuse { background-color: var(--status-refused); color: white; }
        #audio-recorder button { margin-right: 10px; padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); cursor: pointer; }
        #audio-recorder button:disabled { opacity: 0.5; cursor: not-allowed; }
        #recordings-list audio { width: 100%; margin-top: 10px; }
        .recording-item { display: flex; align-items: center; justify-content: space-between; }
        .delete-recording-btn { background: none; border: none; color: var(--status-refused); font-size: 1.2em; cursor: pointer; }

        /* --- Modal pour les outils d'analyse --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px;
            width: 90%; max-width: 800px; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 { margin-top: 0; }
        .modal-close { float: right; font-size: 1.5em; cursor: pointer; border: none; background: none; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .analysis-grid textarea { width: 95%; min-height: 100px; }

        .empty-state { text-align: center; padding: 50px; color: var(--text-light); }
    </style>
</head>
<body>
    <aside id="sidebar">
        <h1>Synchro-Board</h1>
        <ul id="collaborator-list"></ul>
        <button id="add-collaborator-btn">+ Nouveau Collaborateur</button>
    </aside>

    <main id="main-content">
        <header id="header"><h2 id="collaborator-title"></h2></header>
        <div id="view-switcher">
            <div class="tabs">
                <div class="tab active" data-view="roadmaps-view">Feuilles de Route</div>
                <div class="tab" data-view="proposals-view">Propositions Externes</div>
                <div class="tab" data-view="cr-view">CR & Décisions</div>
            </div>
        </div>
        <div id="main-view-container">
            <div id="roadmaps-view" class="view active view-container"></div>
            <div id="proposals-view" class="view view-container"></div>
            <div id="cr-view" class="view view-container"></div>
            <div id="empty-state-view" class="view"></div>
        </div>
    </main>

    <!-- Modal pour les outils d'analyse -->
    <div id="analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- State Management & Definitions ---
    let state = {};
    let mediaRecorder;
    let audioChunks = [];

    const PROPOSAL_CRITERIA = {
        scoring: [
            { key: 'c1', label: '1. Alignement avec les missions' },
            { key: 'c2', label: '2. Cohérence avec les axes stratégiques et le projet associatif' },
            { key: 'c3', label: "3. Renforcement de l'identité de la ML" },
            { key: 'c4', label: '4. Public cible' },
            { key: 'c5', label: '5. Impact potentiel sur les jeunes' },
            { key: 'c6', label: '6. Modalités pédagogiques, caractère innovant, participation des jeunes, support au diagnostic' },
            { key: 'c7', label: "7. Nombre de bénéficiaires potentiels/ Potentiel d'extension à d'autres groupes" },
            { key: 'c8', label: '8. Faisabilité RH nombre de salariés mobilisés, impact sur la charge de travail' },
            { key: 'c9', label: '9. Faisabilité financière cout total estimé Potentiel de financement externe' },
        ],
        final_comment: { key: 'c10', label: '10. Avis référent interne' }
    };

    function saveState() {
        localStorage.setItem('synchroBoardStrategicState', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('synchroBoardStrategicState');
        if (savedState) {
            state = JSON.parse(savedState);
        } else {
            const initialCollabId = `collab-${Date.now()}`;
            state = {
                collaborators: {
                    [initialCollabId]: {
                        id: initialCollabId, name: "Premier Collaborateur",
                        roadmaps: [], activeRoadmapId: null,
                        proposals: {}, activeProposalId: null, proposalFilter: 'all',
                        crs: [], activeCrId: null
                    }
                },
                activeCollaboratorId: initialCollabId,
                activeView: 'roadmaps-view',
            };
        }
    }

    // --- Helper & Utility Functions ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        const viewEl = document.getElementById(viewId);
        if (viewEl) viewEl.style.display = 'block';
        document.getElementById('view-switcher').style.display = (viewId === 'empty-state-view') ? 'none' : 'block';
    }

    function calculateRawScore(proposal) { return PROPOSAL_CRITERIA.scoring.reduce((sum, crit) => sum + (Number(proposal.criteria[crit.key]?.s) || 0), 0); }
    function getDisplayScore(rawScore) { const max = PROPOSAL_CRITERIA.scoring.length * 2; return max === 0 ? 0 : (rawScore / max) * 20; }
    function createTaskElement(task) { return `<li class="task status-${task.status.toLowerCase().replace(/[^a-z]/g, '')}" data-task-id="${task.id}"><span>${task.text}</span><div class="task-controls"><select class="task-status"><option value="À faire" ${task.status === 'À faire' ? 'selected' : ''}>À faire</option><option value="En cours" ${task.status === 'En cours' ? 'selected' : ''}>En cours</option><option value="Terminé" ${task.status === 'Terminé' ? 'selected' : ''}>Terminé</option><option value="Bloqué" ${task.status === 'Bloqué' ? 'selected' : ''}>Bloqué</option></select><button class="delete-task-btn" title="Supprimer">&times;</button></div></li>`; }

    // --- Main Render Functions ---
    function render() {
        saveState();
        renderCollaborators();
        renderActiveView();
    }

    function renderCollaborators() { 
        const listEl = document.getElementById('collaborator-list');
        listEl.innerHTML = '';
        if (Object.keys(state.collaborators).length === 0) {
            showView('empty-state-view'); return;
        }
        for (const collabId in state.collaborators) {
            const collaborator = state.collaborators[collabId];
            const li = document.createElement('li');
            li.textContent = collaborator.name;
            li.dataset.collaboratorId = collaborator.id;
            if (collaborator.id === state.activeCollaboratorId) li.classList.add('active');
            li.addEventListener('click', () => { state.activeCollaboratorId = collaborator.id; render(); });
            listEl.appendChild(li);
        }
     }

    function renderActiveView() {
        const activeCollaborator = state.collaborators[state.activeCollaboratorId];
        if (!activeCollaborator) {
            showView('empty-state-view');
            document.getElementById('collaborator-title').textContent = '';
            return;
        }
        
        document.getElementById('collaborator-title').textContent = `Suivi de : ${activeCollaborator.name}`;
        showView(state.activeView);
        
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.toggle('active', t.dataset.view === state.activeView);
        });

        switch (state.activeView) {
            case 'roadmaps-view': renderRoadmapsView(activeCollaborator); break;
            case 'proposals-view': renderProposalsView(activeCollaborator); break;
            case 'cr-view': renderCRsView(activeCollaborator); break;
        }
    }

    // --- View-Specific Renderers ---
    function renderRoadmapsView(collaborator) {
        const container = document.getElementById('roadmaps-view');
        container.innerHTML = `
            <aside class="sidebar-container">
                <h3>Périodes</h3>
                <ul class="sidebar-list" id="roadmap-list"></ul>
                <button class="add-item-btn" id="add-roadmap-btn">+ Nouvelle Feuille de Route</button>
            </aside>
            <section class="detail-container" id="roadmap-detail-container"></section>`;
        
        const listEl = document.getElementById('roadmap-list');
        (collaborator.roadmaps || []).forEach(roadmap => {
            const li = document.createElement('li');
            li.textContent = roadmap.period;
            li.dataset.roadmapId = roadmap.id;
            if (roadmap.id === collaborator.activeRoadmapId) li.classList.add('active');
            li.addEventListener('click', () => { collaborator.activeRoadmapId = roadmap.id; render(); });
            listEl.appendChild(li);
        });
        
        const roadmap = (collaborator.roadmaps || []).find(r => r.id === collaborator.activeRoadmapId);
        const detailEl = document.getElementById('roadmap-detail-container');
        if (!roadmap) {
            detailEl.innerHTML = '<div class="empty-state"><p>Sélectionnez une feuille de route.</p></div>';
            return;
        }
        
        const tasksHtml = (roadmap.priorityTasks || []).map(createTaskElement).join('');
        detailEl.innerHTML = `
            <div class="roadmap-grid">
                <div class="detail-field half"><label>Période</label><input type="text" data-field="period" value="${roadmap.period || ''}"></div>
                <div class="detail-field half"><label>Prochaine rencontre</label><input type="text" data-field="nextMeeting" value="${roadmap.nextMeeting || ''}"></div>
                <div class="detail-field full">
                    <label>Objectifs principaux <button class="analysis-btn" data-tool="level2" title="Analyse de 2e niveau">🧠</button></label>
                    <textarea data-field="mainObjectives">${roadmap.mainObjectives || ''}</textarea>
                </div>
                <div class="detail-field full">
                    <label>Tâches prioritaires <button class="analysis-btn" data-tool="impact-effort" title="Matrice Impact/Effort">🧠</button></label>
                    <ul class="task-list">${tasksHtml}</ul>
                    <form id="add-task-form"><input type="text" id="new-task-input" placeholder="Nouvelle tâche..." required><button type="submit" id="add-task-btn">+</button></form>
                </div>
                <div class="detail-field full"><label>Rendez-vous / réunions importantes</label><textarea data-field="meetings">${roadmap.meetings || ''}</textarea></div>
                <div class="detail-field full"><label>Suivi des actions précédentes</label><textarea data-field="followUp">${roadmap.followUp || ''}</textarea></div>
                <div class="detail-field full"><label>Observations / ajustements à prévoir</label><textarea data-field="observations">${roadmap.observations || ''}</textarea></div>
            </div>`;
        attachRoadmapListeners(roadmap);
    }
    
    function renderCRsView(collaborator) {
        const container = document.getElementById('cr-view');
        container.innerHTML = `
            <aside class="sidebar-container">
                <h3>Historique</h3>
                <ul class="sidebar-list" id="cr-list"></ul>
                <button class="add-item-btn" id="add-cr-btn">+ Nouveau CR</button>
            </aside>
            <section class="detail-container" id="cr-detail-container"></section>`;

        const listEl = document.getElementById('cr-list');
        (collaborator.crs || []).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(cr => {
            const li = document.createElement('li');
            li.textContent = `CR du ${new Date(cr.date).toLocaleDateString('fr-FR')}`;
            li.dataset.crId = cr.id;
            if (cr.id === collaborator.activeCrId) li.classList.add('active');
            li.addEventListener('click', () => { collaborator.activeCrId = cr.id; render(); });
            listEl.appendChild(li);
        });

        const cr = (collaborator.crs || []).find(c => c.id === collaborator.activeCrId);
        const detailEl = document.getElementById('cr-detail-container');
        if (!cr) {
            detailEl.innerHTML = '<div class="empty-state"><p>Sélectionnez un compte-rendu.</p></div>';
            return;
        }

        const decisionsHtml = (cr.decisions || []).map((d, i) => `<tr data-decision-index="${i}"><td><input type="text" data-field="decision" value="${d.decision || ''}"></td><td><input type="text" data-field="owner" value="${d.owner || ''}"></td><td><input type="date" data-field="dueDate" value="${d.dueDate || ''}"></td><td><span class="delete-row-btn" title="Supprimer">&times;</span></td></tr>`).join('');
        const recordingsHtml = (cr.recordings || []).map((rec, i) => `
            <div class="recording-item" data-recording-index="${i}">
                <audio controls src="${rec.data}"></audio>
                <button class="delete-recording-btn" title="Supprimer l'enregistrement">&times;</button>
            </div>`).join('');

        detailEl.innerHTML = `
            <div class="roadmap-grid">
                <div class="detail-field half"><label>Date</label><input type="date" data-field="date" value="${cr.date}"></div>
                <div class="detail-field half"><label>Animé par</label><input type="text" data-field="animator" value="${cr.animator || ''}"></div>
                <div class="detail-field half"><label>Présents</label><textarea data-field="attendees">${cr.attendees || ''}</textarea></div>
                <div class="detail-field half"><label>Absents</label><textarea data-field="absentees">${cr.absentees || ''}</textarea></div>
                <div class="detail-field full"><label>Points abordés</label><textarea data-field="discussion">${cr.discussion || ''}</textarea></div>
                <div class="detail-field full">
                    <label>Relevé de décisions</label>
                    <table id="decision-table"><thead><tr><th>Décision</th><th>Porteur</th><th>Échéance</th><th></th></tr></thead><tbody>${decisionsHtml}</tbody></table>
                    <button id="add-decision-btn" class="add-item-btn" style="width:auto; margin-top:10px;">+ Ajouter décision</button>
                </div>
                <div class="detail-field full">
                    <label>Enregistrements Audio</label>
                    <div id="audio-recorder">
                        <button id="record-btn">🎙️ Démarrer l'enregistrement</button>
                        <button id="stop-btn" disabled>⏹️ Arrêter</button>
                    </div>
                    <div id="recordings-list">${recordingsHtml}</div>
                </div>
                <div class="detail-field full">
                    <label>Questions nécessitant une réponse <button class="analysis-btn" data-tool="7s" title="Analyse 7S de McKinsey">🧠</button></label>
                    <textarea data-field="questions">${cr.questions || ''}</textarea>
                </div>
            </div>`;
        attachCRListeners(cr);
    }

    function renderProposalsView(collaborator) {
        const container = document.getElementById('proposals-view');
        container.innerHTML = `
            <aside class="sidebar-container">
                <h3>Propositions</h3>
                <div style="padding: 0 0 10px 0;">
                  <label for="filter-status">Filtrer:</label>
                  <select id="filter-status" style="width:100%; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color);">
                      <option value="all">Toutes</option>
                      <option value="En évaluation">En évaluation</option>
                      <option value="Accepté">Accepté</option>
                      <option value="Refusé">Refusé</option>
                  </select>
                </div>
                <ul class="sidebar-list" id="proposal-list"></ul>
                <button class="add-item-btn" id="add-proposal-btn">+ Nouvelle Proposition</button>
            </aside>
            <section class="detail-container" id="proposal-detail-container"></section>`;
        
        const listEl = document.getElementById('proposal-list');
        const filterEl = document.getElementById('filter-status');
        filterEl.value = collaborator.proposalFilter || 'all';

        const filteredProposals = Object.values(collaborator.proposals || {}).filter(p => {
            return filterEl.value === 'all' || p.status === filterEl.value;
        });
        filteredProposals.sort((a, b) => (calculateRawScore(b) - calculateRawScore(a)));

        filteredProposals.forEach(p => {
            const li = document.createElement('li');
            li.dataset.proposalId = p.id;
            if (p.id === collaborator.activeProposalId) li.classList.add('active');
            const displayScore = getDisplayScore(calculateRawScore(p));
            const statusClass = p.status.replace(' ', '-').toLowerCase();
            li.innerHTML = `<div class="proposal-item-header"><span>${p.name}</span><span class="proposal-score">${displayScore.toFixed(1)}/20</span></div><div class="proposal-item-details"><span>${p.typology}</span> | <span class="status-badge ${statusClass === 'en-évaluation' ? 'eval' : statusClass}">${p.status}</span></div>`;
            li.addEventListener('click', () => { collaborator.activeProposalId = p.id; render(); });
            listEl.appendChild(li);
        });

        const proposal = (collaborator.proposals || {})[collaborator.activeProposalId];
        const detailEl = document.getElementById('proposal-detail-container');
        if (!proposal) {
            detailEl.innerHTML = '<div class="empty-state"><p>Sélectionnez une proposition pour l\'évaluer.</p></div>';
            return;
        }

        const criteriaHtml = PROPOSAL_CRITERIA.scoring.map(crit => {
            const scoreData = proposal.criteria[crit.key] || {s: 0, c: ''};
            const analysis = scoreData.analysis || {};
            const hasAnalysis = Object.values(analysis).some(v => v);
            const analysisDisplay = hasAnalysis ? `
                <div class="swot-display">
                    <p><strong>Forces:</strong> ${analysis.s || '...'}</p>
                    <p><strong>Faiblesses:</strong> ${analysis.w || '...'}</p>
                    <p><strong>Opportunités:</strong> ${analysis.o || '...'}</p>
                    <p><strong>Menaces:</strong> ${analysis.t || '...'}</p>
                </div>` : '';

            return `<div class="criterion">
                <div class="criterion-header">
                    <label>${crit.label}</label>
                    <div class="criterion-score"><input type="range" id="range-${crit.key}" data-criterion="${crit.key}" min="0" max="2" step="0.5" value="${scoreData.s}"><span>${Number(scoreData.s).toFixed(1)}</span></div>
                </div>
                <div class="criterion-comment-area">
                    <button class="analysis-btn" data-tool="swot" data-criterion="${crit.key}" title="Analyse SWOT">🧠 Analyser</button>
                    ${analysisDisplay}
                </div>
            </div>`;
        }).join('');
        const finalCritData = proposal.criteria[PROPOSAL_CRITERIA.final_comment.key] || {s:0, c:''};
        const displayScore = getDisplayScore(calculateRawScore(proposal));

        detailEl.innerHTML = `
            <div class="detail-header"><h2>${proposal.name}</h2><p>${proposal.typology} | Partenaires: ${proposal.partners}</p></div>
            <div class="info-grid">
                <div class="info-item"><h4>Deadline</h4><p>${proposal.deadline || 'N/A'}</p></div>
                <div class="info-item"><h4>Période</h4><p>${proposal.period || 'N/A'}</p></div>
                <div class="info-item" style="grid-column: span 2;"><h4>Attendus pour la ML</h4><p>${proposal.expected || 'Non défini'}</p></div>
            </div>
            <h3>Évaluation des critères</h3>
            ${criteriaHtml}
            <div class="summary-section">
                <h3>Synthèse & Décision</h3>
                <div class="criterion">
                    <label>${PROPOSAL_CRITERIA.final_comment.label}</label>
                    <textarea class="criterion-comment" data-criterion="${PROPOSAL_CRITERIA.final_comment.key}" placeholder="Avis final du référent...">${finalCritData.c}</textarea>
                </div>
                <div class="summary-grid">
                    <div class="total-score"><h3>Score Total</h3><p>${displayScore.toFixed(1)} / 20</p></div>
                    <div class="decision-actions">
                        <button class="btn-eval" data-status="En évaluation">En évaluation</button>
                        <button class="btn-accept" data-status="Accepté">Accepter</button>
                        <button class="btn-refuse" data-status="Refusé">Refuser</button>
                    </div>
                </div>
            </div>`;
        attachProposalListeners(proposal);
    }
    
    // --- Modal & Analysis Tools Logic ---
    const modal = document.getElementById('analysis-modal');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = modal.querySelector('.modal-close');

    modalCloseBtn.addEventListener('click', () => modal.style.display = 'none');
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
    });

    function openAnalysisModal(tool, context) {
        modal.style.display = 'flex';
        let content = '';
        switch(tool) {
            case 'swot':
                const analysis = context.analysis || {};
                content = `
                    <h3>Analyse SWOT pour "${context.label}"</h3>
                    <div class="analysis-grid">
                        <div><label>Forces (Interne)</label><textarea id="swot-s">${analysis.s || ''}</textarea></div>
                        <div><label>Faiblesses (Interne)</label><textarea id="swot-w">${analysis.w || ''}</textarea></div>
                        <div><label>Opportunités (Externe)</label><textarea id="swot-o">${analysis.o || ''}</textarea></div>
                        <div><label>Menaces (Externe)</label><textarea id="swot-t">${analysis.t || ''}</textarea></div>
                    </div>
                    <button id="save-swot-btn">Sauvegarder l'Analyse</button>`;
                modalBody.innerHTML = content;
                document.getElementById('save-swot-btn').onclick = () => {
                    context.analysis = {
                        s: document.getElementById('swot-s').value,
                        w: document.getElementById('swot-w').value,
                        o: document.getElementById('swot-o').value,
                        t: document.getElementById('swot-t').value,
                    };
                    modal.style.display = 'none';
                    render();
                };
                break;
            // Other cases for '7s', 'level2', 'impact-effort' would go here
        }
    }

    // --- Event Listeners ---
    function attachRoadmapListeners(roadmap) {
        const container = document.getElementById('roadmap-detail-container');
        container.addEventListener('change', e => {
            const field = e.target.dataset.field;
            if (field) { roadmap[field] = e.target.value; if(field === 'period') render(); saveState(); }
            if (e.target.classList.contains('task-status')) {
                const taskId = e.target.closest('.task').dataset.taskId;
                roadmap.priorityTasks.find(t => t.id === taskId).status = e.target.value;
                render();
            }
        });
        container.addEventListener('click', e => {
            if (e.target.classList.contains('delete-task-btn')) {
                const taskId = e.target.closest('.task').dataset.taskId;
                roadmap.priorityTasks = roadmap.priorityTasks.filter(t => t.id !== taskId);
                render();
            }
        });
        container.querySelector('#add-task-form').addEventListener('submit', e => {
            e.preventDefault();
            const input = e.target.querySelector('input');
            if (input.value.trim()) {
                roadmap.priorityTasks.push({ id: `task-${Date.now()}`, text: input.value.trim(), status: 'À faire' });
                input.value = '';
                render();
            }
        });
    }

    function attachCRListeners(cr) {
        const container = document.getElementById('cr-detail-container');
        container.addEventListener('change', e => {
            const field = e.target.dataset.field;
            if (field && e.target.closest('tr') === null) {
                cr[field] = e.target.value;
                if(field === 'date') render();
                saveState();
            } else if (field) {
                const index = e.target.closest('tr').dataset.decisionIndex;
                cr.decisions[index][field] = e.target.value;
                saveState();
            }
        });
        container.addEventListener('click', e => {
            if (e.target.id === 'add-decision-btn') {
                cr.decisions = cr.decisions || [];
                cr.decisions.push({ decision: '', owner: '', dueDate: '' });
                render();
            }
            if (e.target.classList.contains('delete-row-btn')) {
                const index = e.target.closest('tr').dataset.decisionIndex;
                cr.decisions.splice(index, 1);
                render();
            }
            if (e.target.classList.contains('delete-recording-btn')) {
                const index = e.target.closest('.recording-item').dataset.recordingIndex;
                cr.recordings.splice(index, 1);
                render();
            }
        });

        // Audio Recorder Logic
        const recordBtn = container.querySelector('#record-btn');
        const stopBtn = container.querySelector('#stop-btn');
        recordBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = function() {
                        const base64data = reader.result;
                        cr.recordings = cr.recordings || [];
                        cr.recordings.push({ data: base64data });
                        render();
                    }
                    stream.getTracks().forEach(track => track.stop()); // Stop microphone access
                });
                recordBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("Impossible d'accéder au microphone. Veuillez vérifier les autorisations de votre navigateur.");
            }
        };
        stopBtn.onclick = () => {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
        };
    }

    function attachProposalListeners(proposal) {
        const container = document.getElementById('proposal-detail-container');
        container.addEventListener('input', e => {
            if (e.target.type === 'range') {
                proposal.criteria[e.target.dataset.criterion].s = parseFloat(e.target.value);
                render();
            }
        });
        container.addEventListener('change', e => {
            if (e.target.classList.contains('criterion-comment')) {
                proposal.criteria[e.target.dataset.criterion].c = e.target.value;
                saveState();
            }
        });
        container.querySelector('.decision-actions').addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                proposal.status = e.target.dataset.status;
                render();
            }
        });
    }

    // --- Global Event Listeners ---
    document.getElementById('add-collaborator-btn').addEventListener('click', () => {
        const name = prompt("Nom du nouveau collaborateur :");
        if (!name) return;
        const newId = `collab-${Date.now()}`;
        state.collaborators[newId] = { id: newId, name: name.trim(), roadmaps: [], crs: [], proposals: {} };
        state.activeCollaboratorId = newId;
        render();
    });

    document.querySelector('.tabs').addEventListener('click', e => { if (e.target.classList.contains('tab')) { state.activeView = e.target.dataset.view; render(); } });
    
    document.getElementById('main-view-container').addEventListener('click', e => {
        const activeCollaborator = state.collaborators[state.activeCollaboratorId];
        if (!activeCollaborator) return;
        if (e.target.id === 'add-roadmap-btn') {
            const period = prompt("Période de la feuille de route (ex: Semaine 29):");
            if (!period) return;
            const newRoadmap = { id: `roadmap-${Date.now()}`, period: period, priorityTasks: [] };
            activeCollaborator.roadmaps = activeCollaborator.roadmaps || [];
            activeCollaborator.roadmaps.push(newRoadmap);
            activeCollaborator.activeRoadmapId = newRoadmap.id;
            render();
        }
        if (e.target.id === 'add-cr-btn') {
            const newCr = { id: `cr-${Date.now()}`, date: new Date().toISOString().split('T')[0], decisions: [], recordings: [] };
            activeCollaborator.crs = activeCollaborator.crs || [];
            activeCollaborator.crs.push(newCr);
            activeCollaborator.crs.sort((a,b) => new Date(b.date) - new Date(a.date));
            activeCollaborator.activeCrId = newCr.id;
            render();
        }
        if (e.target.id === 'add-proposal-btn') {
            const name = prompt("Nom de la nouvelle proposition :");
            if (!name) return;
            const newId = `prop-${Date.now()}`;
            activeCollaborator.proposals[newId] = {
                id: newId, name: name.trim(), status: "En évaluation",
                criteria: [...PROPOSAL_CRITERIA.scoring, PROPOSAL_CRITERIA.final_comment].reduce((acc, crit) => {
                    acc[crit.key] = { s: 0, c: '' }; return acc;
                }, {})
            };
            activeCollaborator.activeProposalId = newId;
            render();
        }
        if (e.target.classList.contains('analysis-btn')) {
            const tool = e.target.dataset.tool;
            let context = {};
            if (tool === 'swot') {
                const critKey = e.target.dataset.criterion;
                const proposal = activeCollaborator.proposals[activeCollaborator.activeProposalId];
                if (!proposal.criteria[critKey]) proposal.criteria[critKey] = {};
                if (!proposal.criteria[critKey].analysis) proposal.criteria[critKey].analysis = {};
                context = {
                    label: PROPOSAL_CRITERIA.scoring.find(c => c.key === critKey).label,
                    analysis: proposal.criteria[critKey].analysis
                };
            }
            openAnalysisModal(tool, context);
        }
    });
    
    document.getElementById('main-view-container').addEventListener('change', e => {
        if (e.target.id === 'filter-status') {
            state.collaborators[state.activeCollaboratorId].proposalFilter = e.target.value;
            render();
        }
    });
    
    // --- Initial Load ---
    loadState();
    Object.values(state.collaborators).forEach(c => {
        if (!c.roadmaps) c.roadmaps = [];
        if (!c.proposals) c.proposals = {};
        if (!c.crs) c.crs = [];
    });
    render();
});
</script>

</body>
</html>

</script>

</body>
</html>
