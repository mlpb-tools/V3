<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchro-Board - Outil d'Analyse Stratégique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7fa;
            --main-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --header-color: #3498db;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --text-dark: #34495e;
            --text-light: #7f8c8d;
            --status-todo: #3498db;
            --status-inprogress: #f1c40f;
            --status-done: #2ecc71;
            --status-blocked: #e74c3c;
            --status-eval: #f1c40f;
            --status-accepted: #2ecc71;
            --status-refused: #e74c3c;
        }

        /* --- Structure Générale --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; display: flex; height: 100vh; overflow: hidden; background-color: var(--bg-color); color: var(--text-dark);
        }
        #sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }

        /* --- Barre Latérale (Collaborateurs) --- */
        #sidebar h1 { font-size: 1.6em; margin: 0 0 20px 0; text-align: center; font-weight: 600; }
        #collaborator-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        #collaborator-list li { padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; border-left: 4px solid transparent; }
        #collaborator-list li:hover { background-color: #34495e; }
        #collaborator-list li.active { background-color: var(--header-color); font-weight: 600; }
        #add-collaborator-btn { background-color: var(--header-color); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1em; }

        /* --- Contenu Principal --- */
        #header { padding: 15px 30px; background-color: var(--main-bg); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow); z-index: 10; }
        #header h2 { margin: 0; font-size: 1.8em; }
        #view-switcher { padding: 20px 30px 0 30px; background-color: var(--bg-color); }
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-light); }
        .tab.active { color: var(--header-color); border-bottom: 3px solid var(--header-color); }
        
        .view { display: none; padding: 20px 30px; }
        .view.active { display: block; }
        
        /* --- Styles Communs aux Vues --- */
        .view-container { display: flex; gap: 20px; height: calc(100vh - 150px); }
        .sidebar-container { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; }
        .sidebar-container h3 { margin-top: 0; }
        .sidebar-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .sidebar-list li { padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; border: 1px solid var(--border-color); background: var(--main-bg); }
        .sidebar-list li.active { background-color: #eaf5ff; border-color: var(--header-color); }
        .add-item-btn { width: 100%; margin-top: 10px; padding: 10px; background-color: var(--status-done); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .detail-container { flex-grow: 1; background-color: var(--main-bg); padding: 20px; border-radius: 8px; box-shadow: var(--shadow); overflow-y: auto; }
        .detail-field { margin-bottom: 15px; }
        .detail-field label { display: block; font-weight: 600; margin-bottom: 5px; }
        .detail-field input, .detail-field textarea { width: 98%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-family: inherit; font-size: 1em; }
        .detail-field textarea { min-height: 80px; resize: vertical; }
        .analysis-btn { margin-left: 10px; background: none; border: none; cursor: pointer; font-size: 1.2em; }
        
        /* --- Styles spécifiques (Feuille de Route, CR, Propositions) --- */
        .roadmap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .roadmap-grid .detail-field.full { grid-column: span 2; }
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task { background-color: #fdfdfd; border: 1px solid var(--border-color); padding: 10px; margin-bottom: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .task.status-todo { border-left: 4px solid var(--status-todo); }
        .task.status-inprogress { border-left: 4px solid var(--status-inprogress); }
        .task.status-done { border-left: 4px solid var(--status-done); }
        .task.status-blocked { border-left: 4px solid var(--status-blocked); }
        .task-controls { display: flex; align-items: center; gap: 10px; }
        .task-status { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); }
        .delete-task-btn { background: none; border: none; cursor: pointer; color: #999; font-size: 1.5em; line-height: 1; }
        #add-task-form { display: flex; gap: 10px; margin-top: 15px; }
        #new-task-input { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; }
        #add-task-btn { padding: 8px 15px; border: none; background-color: var(--status-todo); color: white; border-radius: 5px; cursor: pointer; }
        #decision-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #decision-table th, #decision-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        #decision-table th { background-color: #f8f9fa; }
        #decision-table input { width: 95%; border: none; }
        .delete-row-btn { cursor: pointer; color: var(--status-refused); }
        
        /* --- Styles Enregistreur Intelligent --- */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Modal pour les outils d'analyse --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px;
            width: 90%; max-width: 800px; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 { margin-top: 0; }
        .modal-close { float: right; font-size: 1.5em; cursor: pointer; border: none; background: none; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .analysis-grid textarea { width: 95%; min-height: 100px; }

        .empty-state { text-align: center; padding: 50px; color: var(--text-light); }
    </style>
</head>
<body>
    <aside id="sidebar">
        <h1>Synchro-Board</h1>
        <ul id="collaborator-list"></ul>
        <button id="add-collaborator-btn">+ Nouveau Collaborateur</button>
    </aside>

    <main id="main-content">
        <header id="header"><h2 id="collaborator-title"></h2></header>
        <div id="view-switcher">
            <div class="tabs">
                <div class="tab active" data-view="roadmaps-view">Feuilles de Route</div>
                <div class="tab" data-view="proposals-view">Propositions Externes</div>
                <div class="tab" data-view="cr-view">CR & Décisions</div>
            </div>
        </div>
        <div id="main-view-container">
            <div id="roadmaps-view" class="view active view-container"></div>
            <div id="proposals-view" class="view view-container"></div>
            <div id="cr-view" class="view view-container"></div>
            <div id="empty-state-view" class="view"></div>
        </div>
    </main>

    <!-- Modal pour les outils d'analyse (conservé pour les autres vues) -->
    <div id="analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- State Management & Definitions ---
    let state = {};
    
    // --- Variables pour l'enregistreur intelligent ---
    let mediaRecorder;
    let audioChunks = [];
    let recognition;
    let isRecording = false;
    let finalTranscript = '';

    function saveState() {
        localStorage.setItem('synchroBoardStrategicState', JSON.stringify(state));
    }

    function loadState() {
        const savedState = localStorage.getItem('synchroBoardStrategicState');
        if (savedState) {
            state = JSON.parse(savedState);
        } else {
            const initialCollabId = `collab-${Date.now()}`;
            state = {
                collaborators: {
                    [initialCollabId]: {
                        id: initialCollabId, name: "Premier Collaborateur",
                        roadmaps: [], activeRoadmapId: null,
                        proposals: {}, activeProposalId: null, proposalFilter: 'all',
                        crs: [], activeCrId: null
                    }
                },
                activeCollaboratorId: initialCollabId,
                activeView: 'roadmaps-view',
            };
        }
    }

    // --- Helper & Utility Functions ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        const viewEl = document.getElementById(viewId);
        if (viewEl) viewEl.style.display = 'block';
        document.getElementById('view-switcher').style.display = (viewId === 'empty-state-view') ? 'none' : 'block';
    }

    // --- Main Render Functions ---
    function render() {
        saveState();
        renderCollaborators();
        renderActiveView();
    }

    function renderCollaborators() { 
        const listEl = document.getElementById('collaborator-list');
        listEl.innerHTML = '';
        if (Object.keys(state.collaborators).length === 0) {
            showView('empty-state-view'); return;
        }
        for (const collabId in state.collaborators) {
            const collaborator = state.collaborators[collabId];
            const li = document.createElement('li');
            li.textContent = collaborator.name;
            li.dataset.collaboratorId = collaborator.id;
            if (collaborator.id === state.activeCollaboratorId) li.classList.add('active');
            li.addEventListener('click', () => { state.activeCollaboratorId = collaborator.id; render(); });
            listEl.appendChild(li);
        }
    }

    function renderActiveView() {
        const activeCollaborator = state.collaborators[state.activeCollaboratorId];
        if (!activeCollaborator) {
            showView('empty-state-view');
            document.getElementById('collaborator-title').textContent = '';
            return;
        }
        
        document.getElementById('collaborator-title').textContent = `Suivi de : ${activeCollaborator.name}`;
        showView(state.activeView);
        
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.toggle('active', t.dataset.view === state.activeView);
        });

        switch (state.activeView) {
            case 'roadmaps-view': renderRoadmapsView(activeCollaborator); break;
            // case 'proposals-view': renderProposalsView(activeCollaborator); break; // Placeholder for brevity
            case 'cr-view': renderCRsView(activeCollaborator); break;
        }
    }

    // --- View-Specific Renderers ---
    function renderRoadmapsView(collaborator) {
        // ... (Code de la vue Feuille de Route inchangé)
    }
    
    function renderCRsView(collaborator) {
        const container = document.getElementById('cr-view');
        container.innerHTML = `
            <aside class="sidebar-container">
                <h3>Historique des CR</h3>
                <ul class="sidebar-list" id="cr-list"></ul>
                <button class="add-item-btn" id="add-cr-btn">+ Nouveau CR</button>
            </aside>
            <section class="detail-container" id="cr-detail-container"></section>`;

        const listEl = document.getElementById('cr-list');
        (collaborator.crs || []).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(cr => {
            const li = document.createElement('li');
            li.textContent = `CR du ${new Date(cr.date).toLocaleDateString('fr-FR')}`;
            li.dataset.crId = cr.id;
            if (cr.id === collaborator.activeCrId) li.classList.add('active');
            li.addEventListener('click', () => { collaborator.activeCrId = cr.id; render(); });
            listEl.appendChild(li);
        });

        const cr = (collaborator.crs || []).find(c => c.id === collaborator.activeCrId);
        const detailEl = document.getElementById('cr-detail-container');
        if (!cr) {
            detailEl.innerHTML = '<div class="empty-state"><p>Sélectionnez ou créez un compte-rendu.</p></div>';
            return;
        }

        const decisionsHtml = (cr.decisions || []).map((d, i) => `<tr data-decision-index="${i}"><td><input type="text" data-field="decision" value="${d.decision || ''}"></td><td><input type="text" data-field="owner" value="${d.owner || ''}"></td><td><input type="date" data-field="dueDate" value="${d.dueDate || ''}"></td><td><span class="delete-row-btn" title="Supprimer">&times;</span></td></tr>`).join('');

        detailEl.innerHTML = `
            <div class="roadmap-grid">
                <div class="detail-field half"><label>Date</label><input type="date" data-field="date" value="${cr.date}"></div>
                <div class="detail-field half"><label>Animé par</label><input type="text" data-field="animator" value="${cr.animator || ''}"></div>
                <div class="detail-field half"><label>Présents</label><textarea data-field="attendees">${cr.attendees || ''}</textarea></div>
                <div class="detail-field half"><label>Absents</label><textarea data-field="absentees">${cr.absentees || ''}</textarea></div>
            </div>
            
            <!-- ENREGISTREUR INTELLIGENT INTÉGRÉ -->
            <div class="w-full bg-white rounded-2xl space-y-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-700">Enregistreur Intelligent</h3>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <button id="recordButton" class="w-full sm:w-auto flex items-center justify-center gap-3 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                        <span id="recordButtonText">Démarrer l'enregistrement</span>
                    </button>
                    <div id="status" class="flex items-center gap-2 text-gray-600">
                        <div id="statusIndicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span id="statusText">Prêt</span>
                    </div>
                </div>
                
                <div id="audioPlayerContainer" class="hidden">
                     <audio id="audioPlayer" controls class="w-full"></audio>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Transcription</h4>
                        <div id="transcriptContainer" class="h-48 p-4 bg-gray-50 border border-gray-200 rounded-lg overflow-y-auto">
                            <p id="transcript" class="text-gray-600 whitespace-pre-wrap">${cr.transcript || 'La transcription apparaîtra ici...'}</p>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between gap-2 mb-2">
                            <h4 class="text-lg font-semibold text-gray-700">Compte Rendu IA</h4>
                            <button id="summarizeButton" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-sm hover:bg-green-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>Générer</button>
                        </div>
                        <div id="summaryContainer" class="h-48 p-4 bg-gray-50 border border-gray-200 rounded-lg overflow-y-auto flex items-center justify-center">
                            <div id="summaryLoader" class="loader hidden"></div>
                            <p id="summary" class="text-gray-600 whitespace-pre-wrap">${cr.summary || 'Le résumé généré apparaîtra ici.'}</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 pt-4">
                    <div class="flex items-center justify-between">
                        <h4 class="text-lg font-semibold text-gray-700">Rapport d'Équipe Formaté</h4>
                        <button id="teamReportButton" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-sm hover:bg-purple-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">Créer le Rapport</button>
                    </div>
                    <div id="teamReportContainer" class="h-64 p-4 bg-blue-50 border border-blue-200 rounded-lg overflow-y-auto flex items-center justify-center">
                        <div id="teamReportLoader" class="loader hidden"></div>
                        <pre id="teamReport" class="text-gray-800 whitespace-pre-wrap w-full font-sans">${cr.teamReport || 'Le rapport formaté apparaîtra ici...'}</pre>
                    </div>
                </div>
            </div>
            <!-- FIN DE L'INTÉGRATION -->
            
            <div class="detail-field full mt-6">
                <label>Relevé de décisions</label>
                <table id="decision-table"><thead><tr><th>Décision</th><th>Porteur</th><th>Échéance</th><th></th></tr></thead><tbody>${decisionsHtml}</tbody></table>
                <button id="add-decision-btn" class="add-item-btn" style="width:auto; margin-top:10px;">+ Ajouter décision</button>
            </div>
            `;
        attachCRListeners(cr);
    }

    // --- Event Listeners ---
    function attachCRListeners(cr) {
        const container = document.getElementById('cr-detail-container');
        if (!container) return;
        
        // Listeners pour les champs du CR (Date, Animateur, etc.)
        container.addEventListener('change', e => {
            const field = e.target.dataset.field;
            if (field && !e.target.closest('tr')) {
                cr[field] = e.target.value;
                if(field === 'date') render(); else saveState();
            } else if (field) { // Décisions
                const index = e.target.closest('tr').dataset.decisionIndex;
                cr.decisions[index][field] = e.target.value;
                saveState();
            }
        });
        
        container.addEventListener('click', e => {
            if (e.target.id === 'add-decision-btn') {
                cr.decisions = cr.decisions || [];
                cr.decisions.push({ decision: '', owner: '', dueDate: '' });
                render();
            }
            if (e.target.classList.contains('delete-row-btn')) {
                const index = e.target.closest('tr').dataset.decisionIndex;
                cr.decisions.splice(index, 1);
                render();
            }
        });

        // --- LISTENERS POUR L'ENREGISTREUR INTELLIGENT ---
        const recordButton = container.querySelector('#recordButton');
        const summarizeButton = container.querySelector('#summarizeButton');
        const teamReportButton = container.querySelector('#teamReportButton');
        
        if (!recordButton) return; // Si le CR n'est pas sélectionné, les boutons n'existent pas

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            recordButton.disabled = true;
            recordButton.textContent = "Navigateur non compatible";
        }

        recordButton.onclick = async () => {
            if (isRecording) {
                stopIntelligentRecording();
            } else {
                await startIntelligentRecording(cr);
            }
        };

        summarizeButton.onclick = async () => {
            const transcriptText = finalTranscript.trim() || cr.transcript;
            if (!transcriptText || transcriptText.length < 10) {
                alert("La transcription est trop courte.");
                return;
            }
            
            const summaryLoader = container.querySelector('#summaryLoader');
            const summaryEl = container.querySelector('#summary');
            summaryEl.classList.add('hidden');
            summaryLoader.classList.remove('hidden');
            summarizeButton.disabled = true;

            const prompt = `Tu es un assistant expert en rédaction de comptes rendus. Analyse la transcription suivante et génère un compte rendu clair et structuré en français. Le compte rendu doit inclure :\n1.  **Résumé principal**\n2.  **Points Clés**\n3.  **Actions à entreprendre** (si applicable)\n\nTranscription :\n---\n${transcriptText}\n---`;
            
            try {
                const summaryText = await callGeminiAPI(prompt);
                cr.summary = summaryText;
                summaryEl.textContent = summaryText;
                render(); // Re-render to show and save
            } catch (error) {
                summaryEl.textContent = "Erreur de génération.";
                console.error(error);
            } finally {
                summaryEl.classList.remove('hidden');
                summaryLoader.classList.add('hidden');
                summarizeButton.disabled = false;
            }
        };
        
        teamReportButton.onclick = async () => {
            const summaryText = cr.summary;
            if (!summaryText || summaryText.length < 10) {
                alert("Veuillez d'abord générer un compte rendu de base.");
                return;
            }
            
            const teamReportLoader = container.querySelector('#teamReportLoader');
            const teamReportEl = container.querySelector('#teamReport');
            teamReportEl.classList.add('hidden');
            teamReportLoader.classList.remove('hidden');
            teamReportButton.disabled = true;

            const prompt = `En te basant sur le compte rendu suivant, transforme-le en un rapport d'équipe formel en Markdown. Inclue des placeholders pour la date, les participants, le sujet, l'ordre du jour, les décisions et les actions à suivre.\n\nCompte rendu initial :\n${summaryText}`;

            try {
                const reportText = await callGeminiAPI(prompt);
                cr.teamReport = reportText;
                teamReportEl.textContent = reportText;
                 render(); // Re-render to show and save
            } catch (error) {
                teamReportEl.textContent = "Erreur de génération.";
                console.error(error);
            } finally {
                teamReportEl.classList.remove('hidden');
                teamReportLoader.classList.add('hidden');
                teamReportButton.disabled = false;
            }
        };
    }

    // --- Logique de l'enregistreur intelligent ---
    async function startIntelligentRecording(cr) {
        const container = document.getElementById('cr-detail-container');
        if (!container) return;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];
            mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                container.querySelector('#audioPlayer').src = audioUrl;
                container.querySelector('#audioPlayerContainer').classList.remove('hidden');
            });

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.interimResults = true;
            recognition.continuous = true;
            finalTranscript = '';
            const transcriptEl = container.querySelector('#transcript');
            transcriptEl.textContent = '';
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                transcriptEl.textContent = finalTranscript + interimTranscript;
                cr.transcript = transcriptEl.textContent; // Live update
            };

            recognition.onend = () => {
                cr.transcript = finalTranscript; // Save final version
                saveState();
            };
            
            recognition.start();
            isRecording = true;
            updateUIRecorder('recording');
        } catch (error) {
            console.error("Erreur d'accès au microphone:", error);
            alert("Impossible d'accéder au microphone.");
        }
    }

    function stopIntelligentRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        if (recognition) recognition.stop();
        isRecording = false;
        updateUIRecorder('stopped');
    }
    
    async function callGeminiAPI(prompt) {
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiKey = ""; // Gérée par l'environnement
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`Erreur API: ${response.statusText}`);
        const result = await response.json();
        
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
            return result.candidates[0].content.parts[0].text;
        } else {
            throw new Error("Réponse de l'API invalide.");
        }
    }

    function updateUIRecorder(state) {
        const container = document.getElementById('cr-detail-container');
        if (!container) return;
        
        const recordButton = container.querySelector('#recordButton');
        const recordButtonText = container.querySelector('#recordButtonText');
        const micIcon = container.querySelector('#micIcon');
        const statusIndicator = container.querySelector('#statusIndicator');
        const statusText = container.querySelector('#statusText');
        const summarizeButton = container.querySelector('#summarizeButton');

        if (state === 'recording') {
            recordButtonText.textContent = "Arrêter";
            recordButton.classList.replace('bg-blue-600', 'bg-red-600');
            micIcon.innerHTML = `<rect x="6" y="6" width="12" height="12"></rect>`;
            statusText.textContent = 'Enregistrement...';
            statusIndicator.className = `w-3 h-3 bg-red-500 rounded-full animate-pulse`;
            summarizeButton.disabled = true;
        } else { // stopped
            recordButtonText.textContent = "Démarrer l'enregistrement";
            recordButton.classList.replace('bg-red-600', 'bg-blue-600');
            micIcon.innerHTML = `<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line>`;
            statusText.textContent = 'Terminé';
            statusIndicator.className = `w-3 h-3 bg-green-500 rounded-full`;
            summarizeButton.disabled = false;
        }
    }

    // --- Global Event Listeners ---
    document.getElementById('add-collaborator-btn').addEventListener('click', () => {
        const name = prompt("Nom du nouveau collaborateur :");
        if (!name) return;
        const newId = `collab-${Date.now()}`;
        state.collaborators[newId] = { id: newId, name: name.trim(), roadmaps: [], crs: [], proposals: {} };
        state.activeCollaboratorId = newId;
        render();
    });

    document.querySelector('.tabs').addEventListener('click', e => { if (e.target.classList.contains('tab')) { state.activeView = e.target.dataset.view; render(); } });
    
    document.getElementById('main-view-container').addEventListener('click', e => {
        const activeCollaborator = state.collaborators[state.activeCollaboratorId];
        if (!activeCollaborator) return;
        
        if (e.target.id === 'add-cr-btn') {
            const newCr = { 
                id: `cr-${Date.now()}`, 
                date: new Date().toISOString().split('T')[0], 
                decisions: [],
                transcript: '',
                summary: '',
                teamReport: ''
            };
            activeCollaborator.crs = activeCollaborator.crs || [];
            activeCollaborator.crs.push(newCr);
            activeCollaborator.crs.sort((a,b) => new Date(b.date) - new Date(a.date));
            activeCollaborator.activeCrId = newCr.id;
            render();
        }
    });
    
    // --- Initial Load ---
    loadState();
    Object.values(state.collaborators).forEach(c => {
        if (!c.roadmaps) c.roadmaps = [];
        if (!c.proposals) c.proposals = {};
        if (!c.crs) c.crs = [];
    });
    render();
});
</script>

</body>
</html>
